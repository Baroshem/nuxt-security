# Content Security Policy

:badge[Enabled]{type="success"} Prevent unwanted content from being injected in your app.

---

:ellipsis{right=0px width=75% blur=150px}

Content Security Policy (CSP) helps prevent unwanted content from being injected/loaded into your webpages. This can mitigate cross-site scripting (XSS) vulnerabilities, clickjacking, formjacking, malicious frames, unwanted trackers, and other web client-side attacks.

::alert{type="info"}
ℹ Read more about this header [here](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP).
::

## Usage

This header is enabled by default but you can change its behavior like following.

```ts
export default defineNuxtConfig({
  // Global
  security: {
    headers: {
      contentSecurityPolicy: <OPTIONS>,
    },
  },

  // Per route
  routeRules: {
    '/custom-route': {
      headers: {
        'Content-Security-Policy': <OPTIONS>
      },
    }
  }
})
```

You can also disable this header by `contentSecurityPolicy: false`.

## Default value

By default, Nuxt Security will set following value for this header.

```http
Content-Security-Policy: base-uri 'self'; font-src 'self' https: data:; form-action 'self'; frame-ancestors 'self'; img-src 'self' data:; object-src 'none'; script-src-attr 'none'; style-src 'self' https: 'unsafe-inline'; upgrade-insecure-requests
```

## Available values

The `contentSecurityPolicy` header can be configured with following values.

```ts
contentSecurityPolicy: {
  'child-src'?: CSPSourceValue[];
  'connect-src'?: CSPSourceValue[];
  'default-src'?: CSPSourceValue[];
  'font-src'?: CSPSourceValue[];
  'frame-src'?: CSPSourceValue[];
  'img-src'?: CSPSourceValue[];
  'manifest-src'?: CSPSourceValue[];
  'media-src'?: CSPSourceValue[];
  'object-src'?: CSPSourceValue[];
  'prefetch-src'?: CSPSourceValue[];
  'script-src'?: CSPSourceValue[];
  'script-src-elem'?: CSPSourceValue[];
  'script-src-attr'?: CSPSourceValue[];
  'style-src'?: CSPSourceValue[];
  'style-src-elem'?: CSPSourceValue[];
  'style-src-attr'?: CSPSourceValue[];
  'worker-src'?: CSPSourceValue[];
  'base-uri'?: CSPSourceValue[];
  'sandbox'?: CSPSandboxValue[];
  'form-action'?: CSPSourceValue[];
  'frame-ancestors'?: ("'self'" | "'none'" | string)[];
  'navigate-to'?: ("'self'" | "'none'" | "'unsafe-allow-redirects'" | string)[];
  'report-uri'?: string[];
  'report-to'?: string[];
  'upgrade-insecure-requests'?: boolean;
} | false
```

::callout
#summary
CSPSourceValue type
#content
```ts
type CSPSourceValue =
  | "'self'"
  | "'unsafe-eval'"
  | "'wasm-unsafe-eval'"
  | "'unsafe-hashes'"
  | "'unsafe-inline'"
  | "'none'"
  | "'strict-dynamic'"
  | "'report-sample'"
  | "'nonce=<base64-value>'"
  | string;
```
::

::callout
#summary
CSPSandboxValue type
#content
```ts
type CSPSandboxValue =
| 'allow-downloads'
| 'allow-downloads-without-user-activation'
| 'allow-forms'
| 'allow-modals'
| 'allow-orientation-lock'
| 'allow-pointer-lock'
| 'allow-popups'
| 'allow-popups-to-escape-sandbox'
| 'allow-presentation'
| 'allow-same-origin'
| 'allow-scripts'
| 'allow-storage-access-by-user-activation'
| 'allow-top-navigation'
| 'allow-top-navigation-by-user-activation'
| 'allow-top-navigation-to-custom-protocols';
```
::

## Strict CSP

Nuxt Security helps you increase the security of your site via **strict CSP** support for both SSR and SSG applications.
You can read more about [strict csp](https://web.dev/strict-csp/#what-is-a-strict-content-security-policy) here.

- For SSR applications, Nuxt Security implements strict CSP via nonces. A one-time cryptographically-generated random nonce is generated at runtime by the server for each request of a page.
- For SSG applications, Nuxt Security implements strict CSP via hashes. At static build-time, Nuxt Security computes the SHA hashes of the elements that are allowed to execute on your site.

Strict CSP is known to be hard to implement.
In order to enable Strict CSP, your application will need to comply with the CSP standards, which may imply some level of code refactoring.

As a starting point, we recommend that you configure the `contentSecurityPolicy` header as follows:

```ts
export default defineNuxtConfig({
  security: {
    headers: {
      contentSecurityPolicy: {
        'script-src': [
          "'self'",  // Fallback value, will be ignored by most modern browsers (level 3)
          "https:", // Fallback value, will be ignored by most modern browsers (level 3)
          "'unsafe-inline'", // Fallback value, will be ignored by almost any browser (level 2)
          "'strict-dynamic'", // Strict CSP via 'strict-dynamic', supported by most modern browsers (level 3)
          "'nonce-{{nonce}}'" // Enables CSP nonce support for scripts in SSR mode, supported by almost any browser (level 2)
        ],
        'style-src': [
          "'self'", // Enables loading of stylesheets hosted on your own domain
          "https:", // For increased security, replace by the specific hosting domain or file name of your external stylesheets
          "'unsafe-inline'" // Recommended default for most Nuxt apps
          //"'nonce-{{nonce}}'" // Disables CSP nonce support for styles in SSR mode (recommended)
        ]
      }
    }
  }
})
```

These default values will enable Strict CSP in the majority of cases.

For further reading about how to configure CSP, please see the links below
- Our Adanced Section about CSP: TBD
- Google CSP Evaluator: https://csp-evaluator.withgoogle.com
- MDN documentation: https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP
- W3C standards: https://www.w3.org/TR/CSP3


## Server Side Rendering (SSR)

Nuxt Security provides first-class support of SSR apps via 'strict-dynamic' and nonces.

To enable Strict CSP in SSR mode, you will need to set the `nonce` option:

```ts
export default defineNuxtConfig({
  security: {
    nonce: true // Enables HTML nonce support in SSR mode
  },
    headers: {
      contentSecurityPolicy // Copy our default recommended value here
    }
})
```

Nuxt Security will add the unique random nonce to all `<script>`, `<link>` and `<style>` tags in your application. The module parses all inline elements as well as all external resources.

In addition, you can also modify the default `contentSecurityPolicy` header by inserting the `"'nonce-{{nonce}}'"` placeholder in your desired locations.
Our starting recommendation is to use the `"'nonce-{{nonce}}'"` placeholder only on the `script-src` policy, but you can use it on any other property of `contentSecurityPolicy`.
For instance, you can add the `"'nonce-{{nonce}}'"` placeholder to the `style-src` property to enable nonce on that policy.

::alert{type="warning"}
Our default recommendation is to avoid using the `"'nonce-{{nonce}}'"` placeholder on `style-src` policy.
<br>
⚠ This is because Nuxt's mechanism for Client-Side hydration of styles could be blocked by CSP in that case.
<br>
For further discussion and alternatives, please refer to our [Advanced Section on CSP](/documentation/advanced/csp).
::


Note: Nonce only works for SSR. The `nonce` option and the `"'nonce-{{nonce}}'"` placeholders are ignored when you build your app for SSG via `nuxi generate`.


## Static site generation (SSG)

This module is meant to work with SSR apps, but you can also use this module in SSG apps where you will get a Content Security Policy (CSP) support via `<meta http-equiv>` tag.

This will result in following code being added to your static app `<head>` tag:

```html
<meta http-equiv="Content-Security-Policy" content="default-src 'self'">
```

::alert{type="info"}
ℹ Read more about this [here](https://content-security-policy.com/examples/meta/).
::


To enable Strict CSP for SSG apps, you will need to set the `ssg` option:

```ts
export default defineNuxtConfig({
  security: {
    ssg: {
      hashScripts: true, // Enables CSP hash support for scripts in SSG mode
      hashStyles: false // Disables CSP hash support for styles in SSG mode (recommended)
    },
    headers: {
      contentSecurityPolicy // Copy our default recommended value here
    }
  }
})
```

Nuxt Security will generate script hashes and style hashes for you according to the `ssg` option:
- `hashScripts`: Nuxt-Security will parse all inline scripts as well as all external scripts. It will add computed hashes of inline scripts as well as `integrity` attributes of external scripts in the `script-src` policy.
- `hashStyles`: Nuxt-Security will parse all inline styles as well as all external styles. It will add computed hashes of inline styles as well as `integrity` attributes of external styles in the `style-src` policy.

::alert{type="warning"}
Our default recommendation is to avoid setting the `ssg: hashStyles` option to `true`.
<br>
⚠ This is because Nuxt's mechanism for Client-Side hydration of styles could be blocked by CSP in that case.
<br>
For further discussion and alternatives, please refer to our [Advanced Section on CSP](/documentation/advanced/csp).
::

::alert{type="info"}
For SSG apps with 'strict-dynamic' mode, external scripts will only be allowed to execute if they carry an integrity attribute. 
<br>
Please see our section on Integrity Hashes [below](#integrity-hashes-for-ssg)
::

Note: Hashes only work for SSG. The `ssg` options are ignored when you build your app for SSR via `nuxi build`.


## Hardening and Debugging CSP

We provide a comprehensive guide in our [Advanded Section on CSP](/documentation/advanced/csp).


## Per-route configuration

The `nonce` value is generated per request and is added to the CSP header. This behaviour can be tweaked on a route level by using the `routeRules` option:

```ts
export default defineNuxtConfig({
  routeRules: {
    '/custom-route': {
      nonce: false    // do not generate nonce for this route (1)
    },
    '/other-route': {
      nonce: true  // generate a new nonce for this route (2)
    }
  }
})
```

## Hot reloading during development

In order to allow hot reloading during development, please enable `'unsafe-inline'` to the `style-src` value.


## Nonce

There are two ways to use `nonce` in your application. Check out both of them and decide which one suits your needs best:

1. **`useHead` composable** - If you are dynamically adding script or link tags in your application using the `useHead` composable, all nonce values will be automatically added.
However, take note that due to [a current bug in unjs/unhead](https://github.com/unjs/unhead/issues/136), you'll need to add a workaround **when using ssr** to prevent double loading and executing of your scripts when using nonce.

```ts
// workaround unjs/unhead bug for double injection when using nonce
// by setting the mode to 'server'
// see: https://github.com/unjs/unhead/issues/136 
useHead({ script: [{ src: 'https://example.com/script.js' }] }, { mode: 'server' })
```

2. **Directly inserting tags into DOM** - If you are unable or unwilling to use `useHead` and are inserting directly into the DOM (e.g. `document.createElement`), you can get the current valid nonce value using the `useNonce` composable:

```ts
const nonce = useNonce()
```

You can then use it with Nuxt Image like following:

```html
<NuxtImg src="https://localhost:8000/api/image/xyz" :nonce="nonce" />
```

## Integrity Hashes For SSG

For SSG apps, if you use 'strict-dynamic' in your `script-src` policy SSG mode, each of your external scripts will need to carry an [integrity attribute](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity).
This is a mandatory requirement of CSP Level 3.

You can easily add integrity values to your scripts with the `useHead` composable:

```ts
useHead({
  script: [
    { 
      src: 'https://example.com/script.js',
      integrity: 'sha384-.....', 
      crossorigin: 'anonymous' 
    }
  ] 
})
```

If you insert scripts manually in your app, you can also include your integrity attribute manually

```html
<script src="https://example.com/script.js" integrity="sha384-....." crossorigin="anonymous" />
```


::alert{type="warning"}
⚠ If you cannot add the integrity attribute to your external scripts, please refer to our [Advanced Section on CSP](/documentation/advanced/csp) for alternatives.
::
